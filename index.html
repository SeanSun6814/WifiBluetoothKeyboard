<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyboard</title>
</head>

<body onload="init()">
    <input id="serverIp" value="192.168.4.1" />
    <input id="inputbox" placeholder="Paste text here..." />
</body>
<script>
    let inputbox;
    let serverIpInputbox;
    let modifierKeyDown = { "Shift": false, "Alt": false, "Control": false };
    let sendQueue = [];
    let sleeping = true;

    function init() {
        inputbox = document.getElementById("inputbox");
        serverIpInputbox = document.getElementById("serverIp");

        inputbox.oninput = inputboxHandler;
        document.body.addEventListener('keyup', (event) => {
            if (event.target !== event.currentTarget) return;
            let char = event.key;
            if (char !== "Shift" && char !== "Alt" && char !== "Control") return;
            if (modifierKeyDown[char] === false) return;
            modifierKeyDown[char] = false;
            char += "Up";
            event.preventDefault();
            console.log("Released key in body: ", char);
            sendQueue.push(char);
            if (sleeping) handleStringArrInput();

        });

        document.body.addEventListener('keydown', (event) => {
            if (event.target !== event.currentTarget) return;
            let char = event.key;
            if (char === "Shift" || char === "Alt" || char === "Control") {
                if (modifierKeyDown[char] === true) return;
                modifierKeyDown[char] = true;
                char += "Down";
                event.preventDefault();
            }
            console.log("Pressed key in body: ", char);
            sendQueue.push(char);
            if (sleeping) handleStringArrInput();
        });
    }

    function inputboxHandler() {
        console.log("Inputbox string value: " + inputbox.value);
        sendQueue = sendQueue.concat(inputbox.value.split(''));
        if (sleeping) handleStringArrInput();
        inputbox.value = "";
    }

    function handleStringArrInput() {
        sleeping = false;
        if (sendQueue.length === 0) return sleeping = true;
        let char = sendQueue.shift();
        // console.log("SendSeq: char[" + char + "], str[" + str + "]");
        let requestUrl = "http://" + serverIpInputbox.value + "/" + translateRequest(char) + "/EF/";
        console.log("requestUrl: " + requestUrl);
        makeRequest(requestUrl, (data) => {
            if (data.status !== 200)
                console.log("REQUEST_FAILED [" + data.status + "]: " + data.res);
            // console.log(data);
            handleStringArrInput();
        });
    }

    function makeRequest(url, callback) {
        let xmlHttp = new XMLHttpRequest();
        xmlHttp.timeout = 1000;
        xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState == 4)
                callback({ status: xmlHttp.status, res: xmlHttp.responseText });
        }
        xmlHttp.open("GET", url, true);
        xmlHttp.send(null);
    }

    function translateRequest(a) {
        if (a === "Enter") { return "ret" }
        else if (a === "Backspace") { return "bk" }
        else if (a === "ArrowUp") { return "up" }
        else if (a === "ArrowDown") { return "dn" }
        else if (a === "ArrowLeft") { return "lf" }
        else if (a === "ArrowRight") { return "rt" }
        else if (a === "Delete") { return "de" }
        else if (a === "Tab") { return "ta" }
        else if (a === "Escape") { return "es" }
        else if (a === "ControlDown") { return "ct" }
        else if (a === "ShiftDown") { return "sf" }
        else if (a === "AltDown") { return "al" }
        else if (a === "ControlUp") { return "ctr" }
        else if (a === "ShiftUp") { return "sfr" }
        else if (a === "AltUp") { return "alr" }
        else if (a === " ") { return "sp" }
        else if (a === "`") { return "bt" }
        else if (a === "~") { return "td" }
        else if (a === "!") { return "em" }
        else if (a === "@") { return "at" }
        else if (a === "#") { return "ht" }
        else if (a === "$") { return "dr" }
        else if (a === "%") { return "pc" }
        else if (a === "^") { return "pr" }
        else if (a === "&") { return "ad" }
        else if (a === "*") { return "st" }
        else if (a === "(") { return "op" }
        else if (a === ")") { return "cp" }
        else if (a === "-") { return "ds" }
        else if (a === "_") { return "us" }
        else if (a === "=") { return "eq" }
        else if (a === "+") { return "pl" }
        else if (a === "[") { return "so" }
        else if (a === "{") { return "co" }
        else if (a === "]") { return "sc" }
        else if (a === "}") { return "cc" }
        else if (a === "\\") { return "bs" }
        else if (a === "|") { return "vb" }
        else if (a === ";") { return "sm" }
        else if (a === ":") { return "cn" }
        else if (a === "'") { return "sq" }
        else if (a === "\"") { return "dq" }
        else if (a === ",") { return "cm" }
        else if (a === "<") { return "lt" }
        else if (a === ".") { return "dt" }
        else if (a === ">") { return "gt" }
        else if (a === "/") { return "fs" }
        else if (a === "?") { return "qm" }
        return a;
    }
</script>

</html>